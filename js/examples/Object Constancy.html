<!DOCTYPE html>
<html class="ocks-org do-not-copy"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta charset="utf-8">
<title>Object Constancy</title>
<style>

@import url(../style.css?aea6f0a);

svg {
  font: 10px sans-serif;
}

.bar rect {
  fill: steelblue;
}

.bar:hover rect {
  fill: brown;
}

.value {
  fill: white;
}

.axis {
  shape-rendering: crispEdges;
}

.axis path {
  stroke: none;
}

.x.axis line {
  stroke: #fff;
  stroke-opacity: .8;
}

.y.axis path {
  stroke: black;
}

</style>

</head><body><header>
  <aside>May 16, 2012</aside>
  <a href="https://bost.ocks.org/mike/" rel="author">Mike Bostock</a>
</header>

<h1>Object Constancy</h1>

<p id="chart">

<svg width="1040" height="250" style="margin-left: -40px;"><g transform="translate(40,20)"><g class="bar" transform="translate(0,132)" style="fill-opacity: 1;"><rect height="19" width="811.1871423064711"></rect><text class="label" x="-3" y="9.5" dy=".35em" text-anchor="end">ND</text><text class="value" y="9.5" dy=".35em" text-anchor="end" x="808.1871423064711">14.7%</text></g><g class="bar" transform="translate(0,6)" style="fill-opacity: 1;"><rect width="960" height="19"></rect><text class="label" x="-3" y="9.5" dy=".35em" text-anchor="end">FL</text><text class="value" x="957" y="9.5" dy=".35em" text-anchor="end">17.4%</text></g><g class="bar" transform="translate(0,27)" style="fill-opacity: 1;"><rect width="867.1641997451713" height="19"></rect><text class="label" x="-3" y="9.5" dy=".35em" text-anchor="end">WV</text><text class="value" x="864.1641997451713" y="9.5" dy=".35em" text-anchor="end">15.7%</text></g><g class="bar" transform="translate(0,48)" style="fill-opacity: 1;"><rect width="847.1446569657695" height="19"></rect><text class="label" x="-3" y="9.5" dy=".35em" text-anchor="end">PA</text><text class="value" x="844.1446569657695" y="9.5" dy=".35em" text-anchor="end">15.3%</text></g><g class="bar" transform="translate(0,69)" style="fill-opacity: 1;"><rect width="835.138202581359" height="19"></rect><text class="label" x="-3" y="9.5" dy=".35em" text-anchor="end">ME</text><text class="value" x="832.138202581359" y="9.5" dy=".35em" text-anchor="end">15.1%</text></g><g class="bar" transform="translate(0,90)" style="fill-opacity: 1;"><rect width="817.2167489056752" height="19"></rect><text class="label" x="-3" y="9.5" dy=".35em" text-anchor="end">IA</text><text class="value" x="814.2167489056752" y="9.5" dy=".35em" text-anchor="end">14.8%</text></g><g class="bar" transform="translate(0,111)" style="fill-opacity: 1;"><rect width="814.3813275721359" height="19"></rect><text class="label" x="-3" y="9.5" dy=".35em" text-anchor="end">HI</text><text class="value" x="811.3813275721359" y="9.5" dy=".35em" text-anchor="end">14.8%</text></g><g class="bar" transform="translate(0,153)" style="fill-opacity: 1;"><rect width="796.8472886995335" height="19"></rect><text class="label" x="-3" y="9.5" dy=".35em" text-anchor="end">SD</text><text class="value" x="793.8472886995335" y="9.5" dy=".35em" text-anchor="end">14.4%</text></g><g class="bar" transform="translate(0,174)" style="fill-opacity: 1;"><rect width="787.1389005892089" height="19"></rect><text class="label" x="-3" y="9.5" dy=".35em" text-anchor="end">AR</text><text class="value" x="784.1389005892089" y="9.5" dy=".35em" text-anchor="end">14.3%</text></g><g class="bar" transform="translate(0,195)" style="fill-opacity: 1;"><rect width="783.4082866751565" height="19"></rect><text class="label" x="-3" y="9.5" dy=".35em" text-anchor="end">MT</text><text class="value" x="780.4082866751565" y="9.5" dy=".35em" text-anchor="end">14.2%</text></g><g class="x axis"><g style="opacity: 1;" transform="translate(0,0)"><line class="tick" y2="230" x2="0"></line><text y="-3" x="0" dy="0em" text-anchor="middle">0.0%</text></g><g style="opacity: 1;" transform="translate(110.39100646972656,0)"><line class="tick" y2="230" x2="0"></line><text y="-3" x="0" dy="0em" text-anchor="middle">2.0%</text></g><g style="opacity: 1;" transform="translate(220.78201293945312,0)"><line class="tick" y2="230" x2="0"></line><text y="-3" x="0" dy="0em" text-anchor="middle">4.0%</text></g><g style="opacity: 1;" transform="translate(331.17303466796875,0)"><line class="tick" y2="230" x2="0"></line><text y="-3" x="0" dy="0em" text-anchor="middle">6.0%</text></g><g style="opacity: 1;" transform="translate(441.56402587890625,0)"><line class="tick" y2="230" x2="0"></line><text y="-3" x="0" dy="0em" text-anchor="middle">8.0%</text></g><g style="opacity: 1;" transform="translate(551.9550170898438,0)"><line class="tick" y2="230" x2="0"></line><text y="-3" x="0" dy="0em" text-anchor="middle">10.0%</text></g><g style="opacity: 1;" transform="translate(662.3460693359375,0)"><line class="tick" y2="230" x2="0"></line><text y="-3" x="0" dy="0em" text-anchor="middle">12.0%</text></g><g style="opacity: 1;" transform="translate(772.737060546875,0)"><line class="tick" y2="230" x2="0"></line><text y="-3" dy="0em" text-anchor="middle" x="0">14.0%</text></g><g style="opacity: 1;" transform="translate(883.1280517578125,0)"><line class="tick" y2="230" x2="0"></line><text y="-3" dy="0em" text-anchor="middle" x="0">16.0%</text></g><path class="domain" d="M0,230V0H960V230"></path></g><g class="y axis"><line class="domain" y2="220"></line></g></g></svg></p><aside>Source: <a href="http://www.census.gov/popest/archives/2000s/vintage_2008/" target="_blank">Census Bureau</a></aside>

<p id="menu"><b>Top States by Age Bracket, 2008</b><br>Age: <select><option>Under 5 Years</option><option>5 to 13 Years</option><option>14 to 17 Years</option><option>18 to 24 Years</option><option>16 Years and Over</option><option>18 Years and Over</option><option>15 to 44 Years</option><option>45 to 64 Years</option><option selected="selected">65 Years and Over</option><option>85 Years and Over</option></select>

<script src="Object%20Constancy_files/d3.js" charset="utf-8"></script>
<script>

var margin = {top: 20, right: 40, bottom: 10, left: 40},
    width = 960,
    height = 250 - margin.top - margin.bottom;

var format = d3.format(".1%"),
    states,
    age;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.ordinal()
    .rangeRoundBands([0, height], .1);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("top")
    .tickSize(-height - margin.bottom)
    .tickFormat(format);

var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .style("margin-left", -margin.left + "px")
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

svg.append("g")
    .attr("class", "x axis");

svg.append("g")
    .attr("class", "y axis")
  .append("line")
    .attr("class", "domain")
    .attr("y2", height);

var menu = d3.select("#menu select")
    .on("change", change);

d3.csv("states-age.csv", function(data) {
  states = data;

  var ages = d3.keys(states[0]).filter(function(key) {
    return key != "State" && key != "Total";
  });

  states.forEach(function(state) {
    ages.forEach(function(age) {
      state[age] = state[age] / state.Total;
    });
  });

  menu.selectAll("option")
      .data(ages)
    .enter().append("option")
      .text(function(d) { return d; });

  menu.property("value", "18 to 24 Years");

  redraw();
});

var altKey;

d3.select(window)
    .on("keydown", function() { altKey = d3.event.altKey; })
    .on("keyup", function() { altKey = false; });

function change() {
  clearTimeout(timeout);

  d3.transition()
      .duration(altKey ? 7500 : 750)
      .each(redraw);
}

function redraw() {
  var age1 = menu.property("value"),
      top = states.sort(function(a, b) { return b[age1] - a[age1]; }).slice(0, 10);

  y.domain(top.map(function(d) { return d.State; }));

  var bar = svg.selectAll(".bar")
      .data(top, function(d) { return d.State; });

  var barEnter = bar.enter().insert("g", ".axis")
      .attr("class", "bar")
      .attr("transform", function(d) { return "translate(0," + (y(d.State) + height) + ")"; })
      .style("fill-opacity", 0);

  barEnter.append("rect")
      .attr("width", age && function(d) { return x(d[age]); })
      .attr("height", y.rangeBand());

  barEnter.append("text")
      .attr("class", "label")
      .attr("x", -3)
      .attr("y", y.rangeBand() / 2)
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .text(function(d) { return d.State; });

  barEnter.append("text")
      .attr("class", "value")
      .attr("x", age && function(d) { return x(d[age]) - 3; })
      .attr("y", y.rangeBand() / 2)
      .attr("dy", ".35em")
      .attr("text-anchor", "end");

  x.domain([0, top[0][age = age1]]);

  var barUpdate = d3.transition(bar)
      .attr("transform", function(d) { return "translate(0," + (d.y0 = y(d.State)) + ")"; })
      .style("fill-opacity", 1);

  barUpdate.select("rect")
      .attr("width", function(d) { return x(d[age]); });

  barUpdate.select(".value")
      .attr("x", function(d) { return x(d[age]) - 3; })
      .text(function(d) { return format(d[age]); });

  var barExit = d3.transition(bar.exit())
      .attr("transform", function(d) { return "translate(0," + (d.y0 + height) + ")"; })
      .style("fill-opacity", 0)
      .remove();

  barExit.select("rect")
      .attr("width", function(d) { return x(d[age]); });

  barExit.select(".value")
      .attr("x", function(d) { return x(d[age]) - 3; })
      .text(function(d) { return format(d[age]); });

  d3.transition(svg).select(".x.axis")
      .call(xAxis);
}

var timeout = setTimeout(function() {
  menu.property("value", "65 Years and Over").node().focus();
  change();
}, 5000);

</script>

</p><p>This bar chart shows the top ten states for a given age bracket, 
sorted by population percentage. For example, Utah’s burgeoning youth 
population earns it the top spot in the <a href="javascript:javascript:menu.property('value',%20'5%20to%2013%20Years'),change()">5 to 13</a> (15.1%) and <a href="javascript:javascript:menu.property('value',%20'Under%205%20Years'),change()">under 5</a> (9.8%) brackets, while Florida is <a href="javascript:menu.property('value',%20'65%20Years%20and%20Over'),change()">popular with retirees</a> (17.4%).

</p><p>The chart shows multiple slices of a dataset, transitioning smoothly when the age bracket changes. The <i>x</i>-axis rescales to accommodate the change in maximum value, while bars reshuffle along the <i>y</i>-axis
 to preserve sorted order. Graphical elements enter and exit: Hawaii 
enters the top ten for the 65 and older age brackets, but fades out in 
younger ones. The axis ticks change suitably, from whole percentages to 
fifths. Old values fade-out while the new values fade-in, both 
translating to preserve a valid display across the transition.

</p><p>Animated transitions are pretty, but they also serve a purpose: they make it easier to follow the data. This is known as <i>object constancy</i>:
 a graphical element that represents a particular data point (such as 
Ohio) can be tracked visually through the transition. This lessens the 
cognitive burden by using preattentive processing of motion rather than 
sequential scanning of labels.

</p><h2><a href="#key-functions" name="key-functions">#</a>Key Functions</h2>

<p>To achieve object constancy with <a href="http://d3js.org/">D3.js</a>, specify a <b>key function</b> as the second argument to <a href="https://github.com/mbostock/d3/wiki/Selections#wiki-data">selection.data</a>.
 This function takes a data point as input and returns a corresponding 
key: a string, such as a name, that uniquely identifies the data point. 
For example, the bar chart above defines data as objects:

</p><pre><code class="javascript">{
  <span class="string">"State"</span>: <span class="string">"ND"</span>,
  <span class="string">"Total"</span>: <span class="number">641481</span>,
  <span class="string">"Under 5 Years"</span>: <span class="number">0.065</span>,
  <span class="string">"5 to 13 Years"</span>: <span class="number">0.105</span>,
  <span class="string">"14 to 17 Years"</span>: <span class="number">0.053</span>,
  <span class="string">"18 to 24 Years"</span>: <span class="number">0.129</span>,
  <span class="string">"16 Years and Over"</span>: <span class="number">0.804</span>,
  <span class="string">"18 Years and Over"</span>: <span class="number">0.777</span>,
  <span class="string">"15 to 44 Years"</span>: <span class="number">0.410</span>,
  <span class="string">"45 to 64 Years"</span>: <span class="number">0.260</span>,
  <span class="string">"65 Years and Over"</span>: <span class="number">0.147</span>,
  <span class="string">"85 Years and Over"</span>: <span class="number">0.028</span>
}</code></pre>

<p>A suitable key function for this data returns the <code class="javascript">State</code> property, a <a href="http://www.itl.nist.gov/fipspubs/fip5-2.htm">FIPS code</a>:

</p><pre><code class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">key</span><span class="params">(d)</span> {</span>
  <span class="keyword">return</span> d.State;
}</code></pre>

<p>When you join the top-ten states to the bars, three selections are returned:

</p><pre><code class="javascript"><span class="keyword">var</span> bar = svg.selectAll(<span class="string">".bar"</span>)
    .data(top, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span> <span class="keyword">return</span> d.State; });</code></pre>

<p>The selection <code class="javascript">bar</code> is the <i>update</i> selection: states that persist across the transition. The selections <code class="javascript">bar.enter()</code> and <code class="javascript">bar.exit()</code> are the <i>enter</i> and <i>exit</i> selections: states that are incoming or outgoing, respectively. For more on these three selections, see <a href="https://bost.ocks.org/mike/join/">Thinking with Joins</a>.

</p><p>For example, when changing from the 18-24 bracket to 14-17, 
Alaska moves from spot #5 to #1. Since it is in the top ten in both age 
brackets, it is in the update selection. An update transition 
interpolates the transform attribute to translate Alaska smoothly to its
 new position. Simultaneous subtransitions resize the bar and reposition
 the associated label:

</p><pre><code class="javascript"><span class="keyword">var</span> barUpdate = d3.transition(bar)
    .attr(<span class="string">"transform"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span> <span class="keyword">return</span> <span class="string">"translate(0,"</span> + y(d.State) + <span class="string">")"</span>; });

barUpdate.select(<span class="string">"rect"</span>)
    .attr(<span class="string">"width"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span> <span class="keyword">return</span> x(d[age]); });

barUpdate.select(<span class="string">"text"</span>)
    .attr(<span class="string">"x"</span>, <span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span> <span class="keyword">return</span> x(d[age]) - <span class="number">3</span>; })
    .text(<span class="function"><span class="keyword">function</span><span class="params">(d)</span> {</span> <span class="keyword">return</span> format(d[age]); });</code></pre>

<p>Transitions are also used to fade entering and exiting elements. For the full code, <a href="view-source:https://bost.ocks.org/mike/constancy/">view source</a>.

</p><p>Key functions can be useful for improving performance independent
 of transitions. For example, if you filter a large table, you can use a
 key function to reduce the number of DOM modifications: reorder DOM 
elements in the update selection rather than regenerating them. We used 
this technique at Square to improve the performance of <a href="http://corner.squareup.com/2012/04/building-analytics.html">merchant analytics</a>, and it’s one of the reasons that D3 is faster than most template frameworks.

</p><h2><a href="#when-constancy-matter" name="when-constancy-matter">#</a>When Constancy Matters</h2>

<p>Above all, animation should be meaningful. While it may be visually 
impressive for bars to fly around the screen during transitions, 
animation should only be used when it enhances understanding. 
Transitions between unrelated datasets or dimensions (<i>e.g.</i>, from temperature to stock price) should use a simpler cross-fade or cut rather than gratuitous, nonsensical movement.

</p><p>Use a key function whenever you want to follow graphical elements
 through animation and interaction: filtering (adding or removing 
elements), reordering (sorting), switching dimensions within 
multivariate data, <i>etc.</i> If you forget to specify a key function, 
the default join-by-index can be misleading! Assist your viewers by 
maintaining object constancy.

</p><footer>
  <aside>May 16, 2012</aside>
  <a href="https://bost.ocks.org/mike/" rel="author">Mike Bostock</a>
</footer>

<script>

GoogleAnalyticsObject = "ga", ga = function() { ga.q.push(arguments); }, ga.q = [], ga.l = +new Date;
ga("create", "UA-48272912-3", "ocks.org");
ga("send", "pageview");

</script>
<script async="" src="Object%20Constancy_files/highlight.js"></script>
<script async="" src="Object%20Constancy_files/analytics.js"></script>
</body></html>